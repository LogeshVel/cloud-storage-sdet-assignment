name: Cloud Storage Tiering Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        # Ensure testing libraries are installed even if missing from requirements.txt
        pip install pytest requests pytest-xdist

    - name: Start Storage Service
      run: |
        cd src
        nohup python3 storage_service.py > ../service.log 2>&1 &
        echo "Service started with PID $!"
        
        # Health Check: Wait up to 15 seconds for the service to come online
        echo "Waiting for service to be ready..."
        timeout 15s bash -c 'until curl -s http://localhost:8000/admin/stats > /dev/null; do sleep 1; done'
        echo "Service is up and running!"

    - name: Run tests with coverage
      run: |
        pytest tests/ --cov=src --cov-report=xml --cov-report=term

    - name: Stop Service
      if: always()
      run: |
        pkill -f storage_service.py || true

    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pytest-results
        path: test-report.xml
        retention-days: 5

  performance:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
    
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        # Ensure testing libraries are installed even if missing from requirements.txt
        pip install pytest requests pytest-xdist

    - name: Start Storage Service
      run: |
        cd src
        nohup python3 storage_service.py > ../service.log 2>&1 &
        echo "Service started with PID $!"
        
        # Health Check: Wait up to 15 seconds for the service to come online
        echo "Waiting for service to be ready..."
        timeout 15s bash -c 'until curl -s http://localhost:8000/admin/stats > /dev/null; do sleep 1; done'
        echo "Service is up and running!"

    
    - name: Run performance tests
      run: |
        pytest tests/performance/ -v --benchmark-only --benchmark-json=benchmark.json
    
    - name: Upload benchmark results
      uses: actions/upload-artifact@v3
      with:
        name: benchmark-results
        path: benchmark.json
